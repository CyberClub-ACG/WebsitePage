<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <meta content="" name="description">
    <link href="../img/other/cyberweb%20logo.png" rel="shortcut icon" type="image/jpg"/>
    <meta content="Alexandros Kourtis" name="author">
    <title>Dashboard Cyber Club</title>
    <link crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
          integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css" rel="stylesheet">
    <meta content="#0275d8" name="theme-color">

    <link href="../css/custom.css" rel="stylesheet">
    <link href="../css/style.css" rel="stylesheet">
    <link href="../css/stylemembers.css" rel="stylesheet">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css" rel="stylesheet">

    <style>
        .modal .btn {
            color: white !important;
        }

        .toast {
            background: #0275d8 !important;
        }

        i {
            color: #212529 !important;
        }

        .btn {
            color: #212529 !important;
            border: 1px solid #212529 !important;
            margin: 5px
        }

        footer {
            position: absolute;
            z-index: 88888 !important;
            width: 100%;
        }
    </style>
</head>

<body>

<header class="navbar navbar-dark sticky-top bg-dark flex-md-nowrap p-0 shadow">
    <a class="navbar-brand col-md-3 col-lg-2 me-0 px-3" href="./members.html">Cyber Club Dashboard</a>
    <button aria-controls="sidebarMenu" aria-expanded="false" aria-label="Toggle navigation"
            class="navbar-toggler position-absolute d-md-none collapsed" data-bs-target="#sidebarMenu"
            data-bs-toggle="collapse" type="button">
        <span class="navbar-toggler-icon"></span>
    </button>
    <ul class="navbar-nav px-3">
        <li class="nav-item text-nowrap">
            <a class="nav-link" href="./login.html">Sign out</a>
        </li>
    </ul>
</header>

<div class="container-fluid">
    <div class="row">
        <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse" id="sidebarMenu">
            <div class="position-sticky pt-3">
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link" href="./members.html">
                            <span data-feather="users"></span>
                            Club Members
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="./articles.html">
                            <span data-feather="file"></span>
                            Articles
                        </a>
                    </li>
                </ul>
            </div>
        </nav>

        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <div
                    class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h2>Add new article</h2>
            </div>
            <form class="needs-validation" novalidate>
                <div class="row g-3">
                    <div class="col-sm-6">
                        <label class="form-label" for="title">Title of the article </label>
                        <input class="form-control" id="title" placeholder="Eg. World domination by the machine... "
                               required type="text" value="">
                        <div class="invalid-feedback">
                            Valid title is required.
                        </div>
                    </div>
                </div>
                <br>
                <div class="row g-3">
                    <div class="col-sm-6">
                        <label class="form-label" for="description">Description/Preview of the article </label>
                        <input class="form-control" id="description" placeholder="Eg. Short synopsis of the article... "
                               required type="text" value="">
                        <div class="invalid-feedback">
                            Valid title is required.
                        </div>
                    </div>
                </div>
                <br>
                <div class="row g-3">
                    <div class="col-sm-6">
                        <label class="form-label" for="author">Author of the article </label>
                        <input class="form-control" id="author" placeholder="Eg. John Doe... " required type="text"
                               value="">
                        <div class="invalid-feedback">
                            Valid title is required.
                        </div>
                    </div>
                </div>
                <br>
                <div class="row g-3">
                    <div class="col-sm-6">
                        <label class="form-label" for="imagefile">Image of the article </label>
                        <input class="form-control" id="imagefile" onchange="fileChange(event)"
                               placeholder="Eg. John Doe... " required type="file" value="">
                        <div class="invalid-feedback">
                            Valid title is required.
                        </div>
                    </div>
                </div>
            </form>
            <br>

            <label for="content">
                <h5>Content:</h5>
            </label>
            <br>
            <textarea id="content" name="text"></textarea>
            <button class="btn btn-dark text-white" onclick="addArticle()" style="color: white !important">Add new
                article
            </button>
            <br>
            <br>
        </main>
    </div>
</div>

<div aria-atomic="true" aria-live="assertive"
     class="position-fixed toast align-items-center bottom-0 start-50 translate-middle-x text-white bg-primary border-0"
     id="toast" role="alert" style="margin-bottom: 20px">
    <div class="d-flex">
        <div class="toast-body">
        </div>
        <button aria-label="Close" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                type="button"></button>
    </div>
</div>

<script crossorigin="anonymous"
        integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ=="
        referrerpolicy="no-referrer" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script crossorigin="anonymous" integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4"
        src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js"></script>
<script crossorigin="anonymous" integrity="sha384-uO3SXW5IuS1ZpFPKugNNWqTZRRglnUJK6UAZ/gxOX80nxEkN9NcGZTftn6RzhGWE"
        src="https://cdn.jsdelivr.net/npm/feather-icons@4.28.0/dist/feather.min.js"></script>
<link href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>
<script>
    const state = {
        imagefile: null,
        imagefilename: null,
        simplemde: configMDTextarea()
    }

    function configMDTextarea() {
        return new SimpleMDE({
            element: document.getElementById("content"),
            placeholder: "Type here...",
            spellChecker: false,
        });
    }

    function init() {
        feather.replace();
        'use strict'
    }

    init();

    function isImageUploaded() {
        if (!state.imagefile) {
            showToast("Must have an image");
            return false;
        }
        return true;
    }

    function buildNewArticlePayload() {
        const title = document.getElementById("title").value;
        const author = document.getElementById("author").value;
        const description = document.getElementById("description").value;
        const imagefilename = state.imagefilename;
        const content = state.simplemde.value();

        return {author, title, content, description, imagefilename: imagefilename};
    }


    function buildFormData(newArticlePayload) {
        let formData = new FormData();
        formData.append("imagefile", state.imagefile);
        formData.append("payload", JSON.stringify(newArticlePayload));
        return formData;
    }

    async function addArticle(e) {
        if (!isImageUploaded())
            return;

        const newArticlePayload = buildNewArticlePayload();
        const formData = buildFormData(newArticlePayload);

        const route = "articles/";
        const data = await postRequest(route, formData);
        showToast(data.message);
    }

    async function postRequest(route, payload) {
        return await fetch("https://cyberweb-backend.herokuapp.com/" + route, {
            method: 'POST',
            headers: {
                'xapikey': 'teststringnothardcodeda',
            },
            body: payload,
        })
            .then(response => response)
            .catch((error) => {
                showToast("Something went wrong on the server. Please contact the developer.");
                console.dir(error);
            });
    }


    function showToast(text) {
        const toastoptions = {
            animation: true,
            autohide: true,
            delay: 2000
        }

        const toastEl = document.getElementById("toast");
        toastEl.getElementsByClassName("toast-body")[0].innerText = text;
        new bootstrap.Toast(toastEl, toastoptions).show();
    }

    function fileChange(event) {
        state.imagefile = event.target.files[0];
        state.imagefilename = event.target.files[0].name;
    }
</script>

</body>

</html>
