<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <link href="../css/cookie.css" rel="stylesheet">
    <meta content="" name="description">
    <meta content="Alexandros Kourtis" name="author">

    <link href="../img/other/cyberweb%20logo.png" rel="shortcut icon" type="image/jpg"/>
    <title>CyberWeb Dashboard</title>
    <link crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
          integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css" rel="stylesheet">
    <meta content="#0275d8" name="theme-color">

    <link href="../css/custom.css" rel="stylesheet">
    <link href="../css/style.css" rel="stylesheet">
    <link href="../css/stylemembers.css" rel="stylesheet">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css" rel="stylesheet">

    <style>
        .modal .btn {
            color: white !important;
        }

        .toast {
            background: #0275d8 !important;
            z-index: 9999999999999 !important;
        }

        i {
            color: #212529 !important;
        }

        .btn {
            border: 1px solid #212529 !important;
        }

        footer {
            position: absolute;
            z-index: 88888 !important;
            width: 100%;
        }

        .main {
            min-height: 100vh;
        }

        #myspinner {
            visibility: hidden;
        }

        #myspinnerBtn {
            visibility: hidden;
        }
    </style>
    <script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }

        gtag('js', new Date());

        gtag('config', 'G-117Y4FD2GM');
    </script>
</head>

<body>

<header class="navbar navbar-dark sticky-top bg-dark flex-md-nowrap p-0 shadow">
    <a class="navbar-brand col-md-3 col-lg-2 me-0 px-3" href="./login.html">Cyber<span
            style="color: #0d6efd"><b>Web</b></span> Dashboard</a>
    <button aria-controls="sidebarMenu" aria-expanded="false" aria-label="Toggle navigation"
            class="navbar-toggler position-absolute d-md-none collapsed" data-bs-target="#sidebarMenu"
            data-bs-toggle="collapse" type="button">
        <span class="navbar-toggler-icon"></span>
    </button>
    <input aria-label="Search" class="form-control form-control-dark w-100" oninput="filter(event)"
           placeholder="Search" type="text">
    <ul class="navbar-nav px-3">
        <li class="nav-item text-nowrap">
            <a class="nav-link" href="login.html">Sign out</a>
        </li>
    </ul>
</header>

<div class="main">

    <div class="container-fluid">
        <div class="row">
            <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse" id="sidebarMenu">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="./members.html">
                                <span data-feather="users"></span>
                                Club Members
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="./articles.html">
                                <span data-feather="file"></span>
                                Articles
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div
                        class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h3>Edit article</h3>
                    <span id="viewbtn"></span>
                </div>
                <form class="needs-validation" novalidate>
                    <div class="row g-3">
                        <div class="col-sm-6">
                            <label class="form-label" for="title">Title of the article </label>
                            <input class="form-control" id="title" placeholder="Eg. World domination by the machine... "
                                   required type="text" value="">
                            <div class="invalid-feedback">
                                Valid title is required.
                            </div>
                        </div>
                    </div>
                    <br>
                    <div class="row g-3">
                        <div class="col-sm-6">
                            <label class="form-label" for="description">Description/description of the article </label>
                            <input class="form-control" id="description"
                                   placeholder="Eg. Short synopsis of the article... "
                                   required type="text" value="">
                            <div class="invalid-feedback">
                                Valid title is required.
                            </div>
                        </div>
                    </div>
                    <br>
                    <div class="row g-3">
                        <div class="col-sm-6">
                            <label class="form-label" for="author">Author of the article </label>
                            <input class="form-control" id="author" placeholder="Eg. John Doe... " required type="text"
                                   value="">
                            <div class="invalid-feedback">
                                Valid title is required.
                            </div>
                        </div>
                    </div>
                    <br>
                    <div class="row g-3">
                        <div class="col-sm-6">
                            <label class="form-label" for="imagefilename">File name of the image selected for the
                                article </label>
                            <input class="form-control" id="imagefilename" placeholder="File selected" required
                                   type="text" value="">
                            <br>
                            <button class="btn btn-dark" onclick="shownewimageinput(event)">Clear Image</button>
                            <input class="form-control mt-3" id="imagedescription" onchange="fileChange(event)"
                                   placeholder="Eg. John Doe... " required style="display: none;" type="file"
                                   value="">
                            <div class="invalid-feedback">
                                Valid title is required.
                            </div>
                        </div>
                    </div>
                </form>
                <br>

                <label for="content">
                    <h5>Content:</h5>
                </label>
                <br>
                <textarea id="content" name="text"></textarea>
                <div>
                    <div id="spinnerwrapper">
                        <div style="float: left;">
                            <button class="btn btn-dark text-white" id="btn" onclick="updateArticle()"
                                    style="color: white !important;"
                                    type="button">Save changes
                            </button>
                            <button class="btn btn-dark text-white ml-4" onclick="reset()">Reset
                                changes
                            </button>
                        </div>
                        <div class="spinner-border" id="myspinnerBtn" role="status"
                             style="float: left; margin-left: 10px"
                        >
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
                <br>
                <br>
            </main>
        </div>
    </div>

    <div class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
        <div class="spinner-border" id="myspinner" role="status" style="margin: 20px auto">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
</div>
<footer class="site-footer">
    <div class="alert text-center cookiealert" role="alert">
        <b>Do you like cookies?</b> &#x1F36A; We use cookies to ensure you get the best experience on the website. <a
            href="https://cookiesandyou.com/" target="_blank">Learn more</a>

        <button class="btn btn-primary btn-sm acceptcookies" type="button">
            I agree
        </button>
    </div>
    <div class="container" style="text-align: left ">
        <div class="row">
            <div class="col-sm-12 col-md-6">
                <h6>About us</h6>
                <h5>The Cyber Club is open to all students who are interested in the IT
                    field. It aims to cultivate a community of motivated
                    individuals who are passionate about technology and want to enrich their academic and
                    student-life experience at Deree.</h5>
                <h5>Email: dc.cyberclub@acg.edu
                </h5>
                <h5>
                    Advisor: George Vardoulias
                </h5>
            </div>

            <div class="col-xs-6 col-md-3">
                <h6>Interests</h6>
                <ul class="footer-links">
                    <li>
                        <h5>Cybersecurity</h5>
                    </li>
                    <li>
                        <h5>Software Engineering</h5>
                    </li>
                    <li>
                        <h5>Machine Learning</h5>
                    </li>
                    <li>
                        <h5>Artificial
                            Intelligence</h5>
                    </li>
                    <li>
                        <h5>Operating Systems</h5>
                    </li>
                    <li>
                        <h5>Computer Networks</h5>
                    </li>
                    <li>
                        <h5>Telecommunications</h5>
                    </li>
                </ul>
            </div>

            <div class="col-xs-6 col-md-3">
                <h6>Skillsets developed</h6>
                <ul class="footer-links">
                    <li>
                        <h5>Coding & Algorithms</h5>
                    </li>
                    <li>
                        <h5>Project Management</h5>
                    </li>
                    <li>
                        <h5>Public Speaking & Critical Thinking</h5>
                    </li>
                    <li>
                        <h5>Entrepreneurship</h5>
                    </li>
                    <li>
                        <h5>Research</h5>
                    </li>
                    <li>
                        <h5>Teamwork</h5>
                    </li>
                    <li>
                        <h5>Networking</h5>
                    </li>
                </ul>
            </div>
        </div>

        <br>
    </div>
    <div class="container">
        <div class="row" style="text-align: left ">
            <div class="col-md-10 col-sm-10 col-xs-10">
                <p class="copyright-text" style="float:left;">Copyright &copy; 2022 All Rights Reserved by
                    <a href="#">Cyber Club</a>. Reach out to us at: <a
                            href="mailto:dc.cyberclub@acg.edu">dc.cyberclub@acg.edu</a>.
                    <br><br>Secret portal: <a
                            href="../html/login.html">cyberweb</a>
                </p>
                <img alt="" id="cyberlastlogo" src="../img/other/logo_trans.png"
                     style="float: right; width: 50px; height: 50px">

            </div>
        </div>
    </div>
</footer>
<div aria-atomic="true" aria-live="assertive"
     class="position-fixed toast align-items-center bottom-0 start-50 translate-middle-x text-white bg-primary border-0"
     id="toast" role="alert" style="margin-bottom: 20px">
    <div class="d-flex">
        <div class="toast-body">
        </div>
        <button aria-label="Close" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                type="button"></button>
    </div>
</div>
<script crossorigin="anonymous"
        integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ=="
        referrerpolicy="no-referrer"
        src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script crossorigin="anonymous"
        integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4"
        src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js"></script>
<script crossorigin="anonymous"
        integrity="sha384-uO3SXW5IuS1ZpFPKugNNWqTZRRglnUJK6UAZ/gxOX80nxEkN9NcGZTftn6RzhGWE"
        src="https://cdn.jsdelivr.net/npm/feather-icons@4.28.0/dist/feather.min.js"></script>
<link href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>
<script>
    function getKey() {
        if (!localStorage.getItem('secret')) {
            window.location.href = "login.html";
        }
    }

    getKey();

    showLoading();
    feather.replace();
    'use strict'

    const state = {
        imagedescription: null,
        imagedescriptionfilename: null,
        id: null,
        initialimagefilename: null
    }

    function enableBtn() {
        document.getElementById("btn").disabled = false;
        makeBtnBlue("btn");
    }

    function disableBtn() {
        document.getElementById("btn").disabled = true;
        makeBtnGray("btn");
        makeBtnGray("btn");
    }

    function makeBtnBlue(id) {
        changeClass(id, "btn-primary", "btn-secondary");
    }

    function makeBtnGray(id) {
        changeClass(id, "btn-secondary", "btn-primary");
    }

    function changeClass(id, newclassname, oldclassname) {
        const elm = document.getElementById(id);
        elm.classList.add(newclassname);
        elm.classList.remove(oldclassname);
    }

    function showLoadingBtn() {
        document.getElementById("myspinnerBtn").style.visibility = "visible";
    }

    function hideLoadingBtn() {
        document.getElementById("myspinnerBtn").style.visibility = "hidden";
    }

    const toastoptions = {
        animation: true,
        autohide: true,
        delay: 2000
    }

    function showToast(text) {
        const toastEl = document.getElementById("toast");
        toastEl.getElementsByClassName("toast-body")[0].innerText = text;
        new bootstrap.Toast(toastEl, toastoptions).show();
    }


    function showLoading() {
        document.getElementById("myspinner").style.display = "block";
        document.getElementsByTagName("main")[0].style.display = "none";
    }

    function hideLoading() {
        document.getElementById("myspinner").style.display = "none";
        document.getElementsByTagName("main")[0].style.display = "block";
    }

    const simplemde = new SimpleMDE({
        element: document.getElementById("content"),
        placeholder: "Type here...",
        spellChecker: false,
    });


    let btnisPressed = false;

    async function updateArticle() {
        showLoadingBtn();
        disableBtn();
        if (!state.imagedescription && btnisPressed) { // if cleared yet no image
            showToast("Must have an image");
        } else if (btnisPressed && state.imagedescription) { // if cleared and uploaded image
            let urlParams = new URLSearchParams(window.location.search);
            let id = state.id;

            let title = document.getElementById("title").value;
            let author = document.getElementById("author").value;
            let description = document.getElementById("description").value;
            let content = simplemde.value();
            let imagefile = state.imagedescription;
            let imagefilename = state.imagedescriptionfilename;
            let payload = {title, author, content, description, imagefilename};
            let route = "article/" + id;

            let formData = new FormData();
            formData.append("imagefile", imagefile);
            formData.append("payload", JSON.stringify(payload));
            await postRequest2(route, formData);
        } else {
            let id = state.id;
            const title = document.getElementById("title").value;
            const author = document.getElementById("author").value;
            const description = document.getElementById("description").value;
            const content = simplemde.value();
            const imagefilename = state.initialimagefilename;
            const payload = {title, author, content, imagefilename, description};

            const route = "articles/" + id;
            await postRequest(route, payload);
        }
        hideLoadingBtn();
        enableBtn();
    }


    async function postRequest2(route, payload) {
        await fetch("https://cyberweb-backend.herokuapp.com/" + route, {
            method: 'POST',
            headers: {
                'xapikey': localStorage.getItem('secret'),
            },
            body: payload,
        })
            .then(async response => await response.json())
            .then(async data => {
                showToast("The article has been updated successfully");
                window.location.assign("https://dccyberclub.com/html/updatearticle.html?titleslug=" + data.titleslug);
            })
            .catch((error) => {
                showToast("Something went wrong");
                console.error('Error:', error);
            });
    }

    async function postRequest(route, payload) {
        await fetch("https://cyberweb-backend.herokuapp.com/" + route, {
            method: 'POST',
            headers: {
                'xapikey': localStorage.getItem('secret'),
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload),
        })
            .then(async response => await response.json())
            .then(async data => {
                showToast("The article has been updated successfully");
                window.location.assign("https://dccyberclub.com/html/updatearticle.html?titleslug=" + data.titleslug);
            })
            .catch((error) => {
                showToast("Something went wrong");
                console.error('Error:', error);
            });
    }

    async function getRequest(route) {
        const options = {
            headers: {
                'xapikey': localStorage.getItem('secret')
            }
        }
        return await fetch('https://cyberweb-backend.herokuapp.com/' + route, options)
            .then(async response => await response.json())
            .then(async data => {
                hideLoading();
                return data;
            })
            .catch(err => console.log(err));
    }

    async function getArticleBySlugTitle(titleslug) {
        const article = await getRequest('articles/findByslug/' + titleslug);
        state.initialimagefilename = article.imagefilename;
        state.id = article._id;
        document.getElementById("title").value = article.title;
        document.getElementById("author").value = article.author;
        document.getElementById("description").value = article.description;
        document.getElementById("imagefilename").value = article.imagefilename;
        document.getElementById("viewbtn").innerHTML = "<a target='_blank' href='blog.html?titleslug=" + article.titleslug + "'>\n" +
            "            <button class='btn btn-dark text-white' style='float: right'>View online\n" +
            "        </button>\n" +
            "        </a>";
        simplemde.value(article.content);
    }

    async function getArticle() {
        const urlParams = new URLSearchParams(window.location.search);
        const titleslug = urlParams.get('titleslug');
        const article = await getRequest('articles/findByslug/' + titleslug);
        state.initialimagefilename = article.imagefilename;
        state.id = article._id;
        document.getElementById("title").value = article.title;
        document.getElementById("author").value = article.author;
        document.getElementById("description").value = article.description;
        document.getElementById("imagefilename").value = article.imagefilename;
        document.getElementById("viewbtn").innerHTML = "<a target='_blank' href='blog.html?titleslug=" + article.titleslug + "'>\n" +
            "            <button class='btn btn-dark text-white' style='float: right'>View online\n" +
            "        </button>\n" +
            "        </a>";
        simplemde.value(article.content);
    }

    getArticle();

    function reset() {
        window.location.reload();
    }

    function fileChange(event) {
        state.imagedescription = event.target.files[0];
        state.imagedescriptionfilename = event.target.files[0].name;
    }

    function shownewimageinput(e) {
        btnisPressed = true;
        state.imagedescription = null;
        e.preventDefault();
        document.getElementById("imagedescription").style.display = "block";
        document.getElementById("imagefilename").style.display = "none";
    }
</script>
<!-- Google tag (gtag.js) -->
<script src="../cookie.js" type="text/javascript"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-117Y4FD2GM"></script>

</body>

</html>
