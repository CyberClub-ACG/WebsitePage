<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <meta content="" name="description">
    <meta content="Alexandros Kourtis" name="author">
    <link href="../img/other/cyberweb%20logo.png" rel="shortcut icon" type="image/jpg"/>
    <title>Dashboard Cyber Club</title>
    <link crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
          integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css" rel="stylesheet">
    <meta content="#0275d8" name="theme-color">

    <link href="../css/custom.css" rel="stylesheet">
    <link href="../css/style.css" rel="stylesheet">
    <link href="../css/stylemembers.css" rel="stylesheet">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css" rel="stylesheet">

    <style>
        .modal .btn {
            color: white !important;
        }

        .toast {
            background: #0275d8 !important;
        }

        .modal-dialog {
            max-width: 750px;
        }

        i {
            color: #212529 !important;
        }

        .btn {
            border: 1px solid #212529 !important;
        }

        footer {
            position: absolute;
            z-index: 88888 !important;
            width: 100%;
        }

        .main {
            height: 100vh;
        }
    </style>
</head>

<body>

<header class="navbar navbar-dark sticky-top bg-dark flex-md-nowrap p-0 shadow">
    <a class="navbar-brand col-md-3 col-lg-2 me-0 px-3" href="./login.html">Cyber<span
            style="color: #0d6efd">Web</span> Dashboard</a>
    <button aria-controls="sidebarMenu" aria-expanded="false" aria-label="Toggle navigation"
            class="navbar-toggler position-absolute d-md-none collapsed" data-bs-target="#sidebarMenu"
            data-bs-toggle="collapse" type="button">
        <span class="navbar-toggler-icon"></span>
    </button>
    <ul class="navbar-nav px-3">
        <li class="nav-item text-nowrap">
            <a class="nav-link" href="./login.html">Sign out</a>
        </li>
    </ul>
</header>

<div class="container-fluid">
    <div class="row">
        <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse" id="sidebarMenu">
            <div class="position-sticky pt-3">
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link" href="./members.html">
                            <span data-feather="users"></span>
                            Club Members
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="./articles.html">
                            <span data-feather="file"></span>
                            Articles
                        </a>
                    </li>
                </ul>
            </div>
        </nav>

        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <div
                    class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h2>Edit article</h2>
                <span id="viewbtn"></span>
            </div>
            <form class="needs-validation" novalidate>
                <div class="row g-3">
                    <div class="col-sm-6">
                        <label class="form-label" for="title">Title of the article </label>
                        <input class="form-control" id="title" placeholder="Eg. World domination by the machine... "
                               required type="text" value="">
                        <div class="invalid-feedback">
                            Valid title is required.
                        </div>
                    </div>
                </div>
                <br>
                <div class="row g-3">
                    <div class="col-sm-6">
                        <label class="form-label" for="description">Description/description of the article </label>
                        <input class="form-control" id="description" placeholder="Eg. Short synopsis of the article... "
                               required type="text" value="">
                        <div class="invalid-feedback">
                            Valid title is required.
                        </div>
                    </div>
                </div>
                <br>
                <div class="row g-3">
                    <div class="col-sm-6">
                        <label class="form-label" for="author">Author of the article </label>
                        <input class="form-control" id="author" placeholder="Eg. John Doe... " required type="text"
                               value="">
                        <div class="invalid-feedback">
                            Valid title is required.
                        </div>
                    </div>
                </div>
                <br>
                <div class="row g-3">
                    <div class="col-sm-6">
                        <label class="form-label" for="imagefilename">File name of the image selected for the
                            article </label>
                        <input class="form-control" id="imagefilename" placeholder="File selected" required
                               type="text" value="">
                        <br>
                        <button class="btn btn-dark" onclick="shownewimageinput(event)">Clear Image</button>
                        <input class="form-control mt-3" id="imagedescription" onchange="fileChange(event)"
                               placeholder="Eg. John Doe... " required style="display: none;" type="file"
                               value="">
                        <div class="invalid-feedback">
                            Valid title is required.
                        </div>
                    </div>
                </div>
            </form>
            <br>

            <label for="content">
                <h5>Content:</h5>
            </label>
            <br>
            <textarea id="content" name="text"></textarea>
            <button class="btn btn-dark text-white" onclick="updateArticle()">Save changes</button>
            <button class="btn btn-dark text-white" onclick="reset()">Reset changes</button>
            <br>
            <br>
        </main>
        <div class="modal" id="myModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Add new club article</h5>
                        <button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
                    </div>
                    <div class="modal-body">
                        <form class="needs-validation" novalidate>
                            <div class="row g-3">
                                <div class="col-sm-6">
                                    <label class="form-label" for="newname">Name</label>
                                    <input class="form-control" id="newname" placeholder="" required type="text"
                                           value="">
                                    <div class="invalid-feedback">
                                        Valid first name is required.
                                    </div>
                                </div>

                                <div class="col-sm-6">
                                    <label class="form-label" for="newemail">Email</label>
                                    <input class="form-control" id="newemail" placeholder="" required type="text"
                                           value="">
                                    <div class="invalid-feedback">
                                        Valid last name is required.
                                    </div>
                                </div>
                                <div class="col-sm-6">
                                    <label class="form-label" for="newstudentid">Student id</label>
                                    <input class="form-control" id="newstudentid" placeholder="" required
                                           type="text" value="">
                                    <div class="invalid-feedback">
                                        Valid first name is required.
                                    </div>
                                </div>

                                <div class="col-sm-6">
                                    <label class="form-label" for="newmajor">Major</label>
                                    <input class="form-control" id="newmajor" placeholder="" required type="text"
                                           value="">
                                    <div class="invalid-feedback">
                                        Valid last name is required.
                                    </div>
                                </div>

                                <div class="col-md-12">
                                    <label class="form-label" for="newrole">Role</label>
                                    <select class="form-select" id="newrole" required>
                                        <option value="Blogger">Choose...</option>
                                        <option value="Admin">Admin</option>
                                        <option value="Manager">Manager</option>
                                        <option value="Blogger">Blogger</option>
                                    </select>
                                    <div class="invalid-feedback">
                                        Please select a valid country.
                                    </div>
                                </div>

                                <div class="col-md-12">
                                    <label class="form-label" for="newhowfoundout">How they found out</label>
                                    <textarea class="form-control col" id="newhowfoundout"
                                              name="howfoundout"></textarea>
                                    <!--                                    <input class="form-control" id="newpassword" placeholder="" required type="text"-->
                                    <!--                                           value="">-->
                                    <div class="invalid-feedback">
                                        Valid last name is required.
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Close</button>
                        <button class="btn btn-primary" onclick='addNew()' type="button">Save changes</button>
                    </div>
                </div>
            </div>
        </div>
        <!--report modal-->
        <div class="modal" id="myReportModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Save report</h5>
                        <button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
                    </div>
                    <div class="modal-body">
                        <form class="needs-validation" novalidate>
                            <div class="row g-3">
                                <div class="col-sm-6">
                                    <label class="form-label" for="title">Title</label>
                                    <input class="form-control" id="titlereport" placeholder="" required type="text"
                                           value="">
                                    <div class="invalid-feedback">
                                        title is required.
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Close</button>
                        <button class="btn btn-primary" onclick='exportToCSV()' type="button">Save changes</button>
                    </div>
                </div>
            </div>
        </div>
        <!--edit modal-->
        <div class="modal" id="myEditModal" tabindex="-1">
        </div>
        <!--view modal-->
        <div class="modal" id="myViewModal" tabindex="-1">
        </div>
    </div>
</div>

<div class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
    <div class="spinner-border" id="myspinner" role="status" style="margin: 20px auto">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<div aria-atomic="true" aria-live="assertive"
     class="position-fixed toast align-items-center bottom-0 start-50 translate-middle-x text-white bg-primary border-0"
     id="toast" role="alert" style="margin-bottom: 20px">
    <div class="d-flex">
        <div class="toast-body">
        </div>
        <button aria-label="Close" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                type="button"></button>
    </div>
</div>

<script crossorigin="anonymous"
        integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ=="
        referrerpolicy="no-referrer" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script crossorigin="anonymous" integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4"
        src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js"></script>
<script crossorigin="anonymous" integrity="sha384-uO3SXW5IuS1ZpFPKugNNWqTZRRglnUJK6UAZ/gxOX80nxEkN9NcGZTftn6RzhGWE"
        src="https://cdn.jsdelivr.net/npm/feather-icons@4.28.0/dist/feather.min.js"></script>
<link href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>
<script>
    function getKey() {
        if (!sessionStorage.getItem('secret')) {
            window.location.href = "login.html";
        }
    }

    getKey();

    showLoading();
    feather.replace();
    'use strict'

    const state = {
        imagedescription: null,
        imagedescriptionfilename: null,
        id: null,
        initialimagefilename: null
    }

    const toastoptions = {
        animation: true,
        autohide: true,
        delay: 2000
    }

    function showToast(text) {
        const toastEl = document.getElementById("toast");
        toastEl.getElementsByClassName("toast-body")[0].innerText = text;
        new bootstrap.Toast(toastEl, toastoptions).show();
    }


    function showLoading() {
        document.getElementById("myspinner").style.display = "block";
        document.getElementsByTagName("main")[0].style.display = "none";
    }

    function hideLoading() {
        document.getElementById("myspinner").style.display = "none";
        document.getElementsByTagName("main")[0].style.display = "block";
    }

    const simplemde = new SimpleMDE({
        element: document.getElementById("content"),
        placeholder: "Type here...",
        spellChecker: false,
    });


    let btnisPressed = false;

    function updateArticle() {
        if (!state.imagedescription && btnisPressed) { // if cleared yet no image
            showToast("Must have an image");
            return;
        } else if (btnisPressed && state.imagedescription) { // if cleared and uploaded image
            let urlParams = new URLSearchParams(window.location.search);
            let id = state.id;

            let title = document.getElementById("title").value;
            let author = document.getElementById("author").value;
            let description = document.getElementById("description").value;
            let content = simplemde.value();
            let imagefile = state.imagedescription;
            let imagefilename = state.imagedescriptionfilename;
            let payload = {title, author, content, description, imagefilename};
            let route = "article/" + id;

            let formData = new FormData();
            formData.append("imagefile", imagefile);
            formData.append("payload", JSON.stringify(payload));
            postRequest2(route, formData);
        } else {
            let id = state.id;
            const title = document.getElementById("title").value;
            const author = document.getElementById("author").value;
            const description = document.getElementById("description").value;
            const content = simplemde.value();
            const imagefilename = state.initialimagefilename;
            const payload = {title, author, content, imagefilename, description};

            const route = "articles/" + id;
            postRequest(route, payload);
        }
    }


    async function postRequest2(route, payload) {
        await fetch("https://cyberweb-backend.herokuapp.com/" + route, {
            method: 'POST',
            headers: {
                'xapikey': sessionStorage.getItem('secret'),
            },
            body: payload,
        })
            .then(response => response.json())
            .then(data => {
                console.log('Success:', data);
                showToast("The article has been updated successfully");
            })
            .catch((error) => {
                console.error('Error:', error);
            });
    }

    async function postRequest(route, payload) {
        await fetch("https://cyberweb-backend.herokuapp.com/" + route, {
            method: 'POST',
            headers: {
                'xapikey': sessionStorage.getItem('secret'),
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload),
        })
            .then(response => response.json())
            .then(async data => {
                await getArticle();
                showToast("The article has been updated successfully");
                console.log('Success:', data);
            })
            .catch((error) => {
                console.error('Error:', error);
            });
    }

    async function getRequest(route) {
        const options = {
            headers: {
                'xapikey': sessionStorage.getItem('secret')
            }
        }
        return await fetch('https://cyberweb-backend.herokuapp.com/' + route, options)
            .then(response => response.json())
            .then(data => {
                hideLoading();
                return data;
            })
            .catch(err => console.log(err));
    }

    async function getArticle() {
        const urlParams = new URLSearchParams(window.location.search);
        const titleslug = urlParams.get('titleslug');
        const article = await getRequest('articles/findByslug/' + titleslug);
        state.initialimagefilename = article.imagefilename;
        state.id = article._id;
        document.getElementById("title").value = article.title;
        document.getElementById("author").value = article.author;
        document.getElementById("description").value = article.description;
        document.getElementById("imagefilename").value = article.imagefilename;
        document.getElementById("viewbtn").innerHTML = "<a href='https://frozen-citadel-66566.herokuapp.com/blog.html?title=" + article.titleblob + "' target='_blank'>\n" +
            "            <button class='btn btn-dark text-white' style='float: right'>View online\n" +
            "        </button>\n" +
            "        </a>";
        simplemde.value(article.content);
    }

    getArticle();

    function reset() {
        window.location.reload();
    }

    function fileChange(event) {
        state.imagedescription = event.target.files[0];
        state.imagedescriptionfilename = event.target.files[0].name;
    }

    function shownewimageinput(e) {
        btnisPressed = true;
        e.preventDefault();
        document.getElementById("imagedescription").style.display = "block";
        document.getElementById("imagefilename").style.display = "none";
    }
</script>

</body>

</html>
